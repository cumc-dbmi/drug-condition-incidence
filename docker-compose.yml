version: '3'

# LINK REFERENCES
# https://dev.to/kanzitelli/deploying-postgresql-and-redis-behind-traefik-in-the-cloud-5an2

services:

  traefik:
    image: docker.io/library/traefik:v2.9.4@sha256:4c388f477f5b7aa48420694d90db0ecb96b4ecede60b9b7589c87858abf87b60
    container_name: howoften-proxy
    restart: unless-stopped
    ipc: none
    read_only: true
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.postgres.address=:5432" # PostgreSQL endpoint
    labels:
      - "traefik.enable=true"
    ports:
      - "${HOWOFTEN_HOST}:80:80"
      - "8080:8080" # Traefik dashboard
      - "${HOWOFTEN_HOST}:5432:5432" # PostgreSQL port
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

  postgres:
    container_name: ${DOCKER_PREFIX}-database
    environment:
      POSTGRES_DB: ${DATASOURCE_DATABASE}
      POSTGRES_USERNAME: ${DATASOURCE_USERNAME}
      POSTGRES_PASSWORD: ${DATASOURCE_PASSWORD}
    image: postgres
    shm_size: 1024MB
    labels:
      - traefik.enable=true
      - traefik.tcp.routers.${DOCKER_PREFIX}-database.entrypoints=postgres
      - traefik.tcp.routers.${DOCKER_PREFIX}-database.rule=HostSNI(`*`)
      - traefik.tcp.routers.${DOCKER_PREFIX}-database.service=${DOCKER_PREFIX}-service
      - traefik.tcp.services.${DOCKER_PREFIX}-service.loadbalancer.server.port=5432
    extra_hosts:
      - "host.docker.internal:host-gateway"

  liquibase:
    container_name: ${DOCKER_PREFIX}-dbscm
    image: liquibase/liquibase
    shm_size: 1024MB
    volumes:
      - ./database/liquibase/changelog:/liquibase/changelog
    command: liquibase --url="jdbc:postgresql://postgres:${DATASOURCE_PORT}/${DATASOURCE_DATABASE}" --searchPath=/liquibase/changelog --changeLogFile=./changelog.xml --username=${DATASOURCE_USERNAME} --password=${DATASOURCE_PASSWORD} update
    depends_on:
      - postgres

  howoften-backend:
    container_name: ${DOCKER_PREFIX}-backend
    image: cumc-dbmi/howoften-backend:latest
    build: ./backend
    restart: unless-stopped
    ipc: none
    read_only: true
    privileged: false
    environment:
      - DATASOURCE_DRIVER
      - DATASOURCE_USERNAME
      - DATASOURCE_PASSWORD
      - DATASOURCE_HOSTNAME
      - DATASOURCE_PORT
      - DATASOURCE_SCHEMA
      - DATASOURCE_DATABASE
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.howoften-backend-app.rule=Host(`${HOWOFTEN_HOST}`) && PathPrefix(`/api/incidence/v2`)"
      - "traefik.http.routers.howoften-backend-ops.rule=Host(`${HOWOFTEN_HOST}`) && PathPrefix(`/ops/incidence/v2`)"
      - "traefik.http.routers.howoften-backend.entrypoints=web"
      - "traefik.http.services.howoften-backend.loadbalancer.server.port=5001"
    ports:
      - 5001:80
    depends_on: 
      - liquibase
    volumes:
      - type: bind
        source: /var/tmp
        target: /var/tmp      

  howoften-frontend:
    container_name: howoften-frontend
    image: cumc-dbmi/howoften-frontend:latest
    build: ./frontend
    restart: unless-stopped
    ipc: none
    privileged: false
    depends_on:
    - howoften-backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.howoften-frontend.rule=Host(`${HOWOFTEN_HOST}`) && PathPrefix(`/`)"
      - "traefik.http.routers.howoften-frontend.entrypoints=web"

  # howoften-backend-legacy:
  #     container_name: ${DOCKER_PREFIX}-backend
  #     image: cumc-dbmi/howoften-backend:latest
  #     build: ./incidence-api
  #     restart: unless-stopped
  #     ipc: none
  #     read_only: true
  #     privileged: false
  #     environment:
  #       - DATASOURCE_DRIVER
  #       - DATASOURCE_USERNAME
  #       - DATASOURCE_PASSWORD
  #       - DATASOURCE_HOSTNAME
  #       - DATASOURCE_PORT
  #       - DATASOURCE_SCHEMA
  #       - DATASOURCE_DATABASE
  #     labels:
  #       - "traefik.enable=true"
  #       - "traefik.http.routers.howoften-backend.rule=Host(`${HOWOFTEN_HOST}`) && PathPrefix(`/incidence-api`)"
  #       - "traefik.http.routers.howoften-backend.entrypoints=web"
  #       - "traefik.http.services.howoften-backend.loadbalancer.server.port=5000"
  #     depends_on: 
  #       - liquibase
  #     volumes:
  #       - type: bind
  #         source: /var/tmp
  #         target: /var/tmp           

  #   howoften-frontend-legacy:
  #   container_name: howoften-frontend
  #   image: cumc-dbmi/howoften-frontend:latest
  #   build: ./client
  #   restart: unless-stopped
  #   ipc: none
  #   privileged: false
  #  depends_on:
  #    - howoften-backend-legacy
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.howoften-frontend.rule=Host(`${HOWOFTEN_HOST}`) && PathPrefix(`/`)"
  #     - "traefik.http.routers.howoften-frontend.entrypoints=web"